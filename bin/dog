#!/bin/bash

BASEPATH="$(dirname $0)/.."
POSTFIX="/node_modules/coffee-script/bin/coffee"
COFFEE="${BASEPATH}${POSTFIX}"
PIDFILE='.coffee.pid'

if [[ ! -f ${COFFEE} ]]; then
    if [[ ! -f "$(pwd)${POSTFIX}" ]]; then
        echo "error! executable file not exist"
        exit 1
    else
        COFFEE="$(pwd)${POSTFIX}"
    fi
fi

function watch {
    echo 'watching'
    [[ -f ${PIDFILE} ]] && echo "error! pid file exist" && exit 2
    ${COFFEE} -w -o lib -c src 2>&1 1>/dev/null &
    echo $! > ${PIDFILE}
    [[ $? > 0 ]] && echo "error! coffee start failed" && exit 3
    echo 'watched'
}

function unwatch {
    echo 'unwatching'
    [ ! -f ${PIDFILE} ] && echo "error! no pid file found" && exit 2
    kill $(cat ${PIDFILE}) && rm .coffee.pid
    [[ $? > 0 ]] && echo "error! stop process error" && exit 3
    echo "unwatched"
}

function generate {
    echo 'generating'
    rm -rf lib/*
    ${COFFEE} -o lib -c src
    echo 'generated'
}

case $1 in
    watch)
        watch
        ;;
    unwatch)
        unwatch
        ;;
    generate)
        generate
        ;;
    *)
        echo "function ${1} not found!" && exit 1
        ;;
esac