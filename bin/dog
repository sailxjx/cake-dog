#!/bin/bash

BASEPATH="$(dirname $0)/.."
POSTFIX="/node_modules/coffee-script/bin/coffee"
COFFEE="${BASEPATH}${POSTFIX}"
PIDFILE='.compile.pid'

if [[ ! -f ${COFFEE} ]]; then
    if [[ ! -f "$(pwd)${POSTFIX}" ]]; then
        echo "error! executable file not exist"
        exit 1
    else
        COFFEE="$(pwd)${POSTFIX}"
    fi
fi

function compile_watch {
    echo 'start watch'
    if [[ -f ${PIDFILE} ]]; then
        PS=$(ps -p $(cat ${PIDFILE}) | grep -v 'grep' | grep 'cake-dog')
        if [[ $PS == '' ]]; then
            echo "process was exited unexpectedly last time"
        else
            echo "error! pid file exist"
            exit 2
        fi
    fi
    ${COFFEE} -w -o lib -c src 2>&1 1>/dev/null &
    echo $! > ${PIDFILE}
    [[ $? > 0 ]] && echo "error! coffee start failed" && exit 3
    echo 'started'
}

function compile_unwatch {
    echo 'stop watch'
    [ ! -f ${PIDFILE} ] && echo "error! no pid file found" && exit 2
    kill $(cat ${PIDFILE}) && rm ${PIDFILE}
    [[ $? > 0 ]] && echo "error! stop process error" && exit 3
    echo "stoped"
}

function compile {
    echo 'compile'
    ${COFFEE} -o lib -c src
    [[ $? > 0 ]] && echo 'compile error' && exit 1
    echo 'compiled'
}

case $1 in
    compile|compile_watch|compile_unwatch)
        $1
        ;;
    *)
        echo "function ${1} not found!" && exit 1
        ;;
esac
